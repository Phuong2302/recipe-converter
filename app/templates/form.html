<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/toast.css') }}">

<body>

    <div class="section bg-gray">
        <div class="grid-hero container grid-lg text-center" id="overview">
            <h1>The Metric Kitchen</h1>
            <h2 class="subtitle">Convert your ingredient list from <u>imperial volume</u> to <u>metric weight</u> units.
            </h2>
        </div>
    </div>
    <div class="section section-features">
        <div class="container grid-lg">
            <div class="columns">
                <div class="column col-6 col-xs-12">
                    <div class="panel">
                        <div class="panel-header">
                            <div class="panel-title">Input Recipe</div>
                        </div>
                        <div class="panel-nav">
                            <!-- navigation components: tabs, breadcrumbs or pagination -->
                        </div>
                        <div class="panel-body">
                            <div class="form-group">
                                <div class="container">
                                    <div class="columns">
                                        <div class="col-2">
                                            <label class="form-label" for="input-multiplier">Scale</label>
                                        </div>
                                        <div class="col-10">
                                            <input type="number" class="form-input" id="input-multiplier"
                                                name="multiplier" value=1.0
                                                placeholder="How many of this recipe do you want?">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <textarea name="text" class="form-input" id="input-recipe"
                                placeholder="Paste URL or ingredient list here"></textarea>
                        </div>
                        <div class="panel-footer">
                            <button id="btn-convert" class="btn btn-primary" value="Convert">Convert</button>
                            <button id="btn-clear" class="btn btn-secondary" value="Clear">Clear</button>
                        </div>
                    </div>
                </div>
                <div class="column col-6 col-xs-12">
                    <div class="panel">
                        <div class="panel-header">
                            <div class="panel-title">Output Recipe</div>
                        </div>
                        <div class="panel-nav">
                            <!-- navigation components: tabs, breadcrumbs or pagination -->
                        </div>
                        <div class="panel-body">
                            <textarea class="form-input" id="output-recipe"
                                placeholder="Converted recipe will appear here"></textarea>
                        </div>
                        <div class="panel-footer">
                            <button id="btn-copy" class="btn btn-success" value="Copy">Copy to Clipboard</button>
                            <button id="btn-reader-view" class="btn btn-secondary">Reader View</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    <div id="reader-view" class="modal modal-lg">
            <a href="#close" class="modal-overlay" aria-label="Close"></a>
            <div class="modal-container">
              <div class="modal-header">
                <a href="" class="btn btn-clear float-right btn-reader-view-close" aria-label="Close"></a>
                <div class="modal-title h5">Recipe</div>
              </div>
              <div class="modal-body">
                <div class="content" id="reader-view-content">
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-link btn-reader-view-close">Close</button>
              </div>
            </div>
    </div>

    <footer class="section section-footer bg-primary">
        <div class="docs-footer container grid-lg text-center">
            <i>
                Check out this project on <a href="https://github.com/justinmklam/recipe-converter">GitHub</a>, or
                read about my other projects at <a href="http://justinmklam.com/">justinmklam.com</a>! Â· <span
                    class="version">v2.0.0</span>
            </i>
        </div>
    </footer>

    <script src="{{ url_for('static', filename='js/toast.js') }}"></script>
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <script>
        var btnConvert = $("#btn-convert")
        var btnClear = $("#btn-clear")
        var btnCopy = $("#btn-copy")
        var btnReaderView = $("#btn-reader-view")
        var btnReaderViewClose = $(".btn-reader-view-close")
        var txtInputRecipe = $("#input-recipe")
        var txtInputMultiplier = $("#input-multiplier")
        var txtReaderView = $("#reader-view-content")
        var txtOutputRecipe = $("#output-recipe")
        var modalReaderView = $("#reader-view")

        window.addEventListener("load", function () {
            btnConvert.on("click", onConvertClicked);
            btnClear.on("click", onClearClicked);
            btnCopy.on("click", onCopyClicked);
            btnReaderView.on("click", onReaderViewClicked);
            btnReaderViewClose.on("click", onReaderViewCloseClicked);
        });

        function convertRecipe(recipe, multiplier) {
            return $.post(
                "convert",
                { "data": recipe, "multiplier": multiplier },
                function (data) {
                    txtOutputRecipe.val(data);
                }
            );
        }

        function onConvertClicked() {
            if (txtInputRecipe.val().includes("http")) {
                btnConvert.prop("disabled", true);
                btnClear.prop("disabled", true);

                // Get ingredients from URL, then convert
                $.post(
                    "ingredients_from_url",
                    { "url": txtInputRecipe.val() },
                    function (data) {
                        txtInputRecipe.val(data["ingredients"])
                        convertRecipe(data["ingredients"], txtInputMultiplier.val())
                            .done(function() {
                                // Append instructions below recipe
                                console.log(data["instructions"])
                                txtOutputRecipe.val(function() {
                                    return this.value + "\n\n" + data["instructions"]
                                })
                            })
                    }
                )
                    .fail(function () {
                        alert("Error: Website not supported for " + txtInputRecipe.val())
                    })
                    .always(function () {
                        btnConvert.prop("disabled", false);
                        btnClear.prop("disabled", false);
                    })
            }
            else {
                // Ingredients entered,
                convertRecipe(txtInputRecipe.val(), txtInputMultiplier.val())
            }
        }

        function onClearClicked() {
            txtInputRecipe.val("");
            txtInputRecipe.focus();
        }

        function onCopyClicked() {
            copyToClipboard(txtOutputRecipe.val());
            new Toast({ message: 'Output recipe copied to clipboard!', type: 'success' });
        }

        function onReaderViewClicked() {
            txtReaderView.text(txtOutputRecipe.val());
            console.log(txtOutputRecipe.val())
            modalReaderView.addClass("active")
        }

        function onReaderViewCloseClicked() {
            modalReaderView.removeClass("active")
        }

        // Copies a string to the clipboard. Must be called from within an
        // event handler such as click. May return false if it failed, but
        // this is not always possible. Browser support for Chrome 43+,
        // Firefox 42+, Safari 10+, Edge and Internet Explorer 10+.
        // Internet Explorer: The clipboard feature may be disabled by
        // an administrator. By default a prompt is shown the first
        // time the clipboard is used (per session).
        function copyToClipboard(text) {
            if (window.clipboardData && window.clipboardData.setData) {
                // Internet Explorer-specific code path to prevent textarea being shown while dialog is visible.
                return clipboardData.setData("Text", text);

            }
            else if (document.queryCommandSupported && document.queryCommandSupported("copy")) {
                var textarea = document.createElement("textarea");
                textarea.textContent = text;
                textarea.style.position = "fixed";  // Prevent scrolling to bottom of page in Microsoft Edge.
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    return document.execCommand("copy");  // Security exception may be thrown by some browsers.
                }
                catch (ex) {
                    console.warn("Copy to clipboard failed.", ex);
                    return false;
                }
                finally {
                    document.body.removeChild(textarea);
                }
            }
        }

    </script>

</html>
